name: "Auto-PR and merge into main"

on:
  push:
    # Only for feature/* branches, for instance
    branches:
      - 'feature/**'
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create_and_merge_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create pull request to main
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: ${{ github.ref_name }}
          title: "Auto-merge ${{ github.ref_name }} â†’ main"
          body: |
            This pull request was auto-generated by a workflow to merge `${{ github.ref_name }}` into `main`.
          draft: false

      - name: Wait for checks & reviews, then merge
        uses: peter-evans/merge-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash       # or "merge" or "rebase"
          commit-title: "Auto-merged ${{ github.ref_name }} into main"
          commit-message: "Automatically merged by GitHub Actions"
          delete-branch: true        # optionally delete the feature branch
